---
layout: ../../layouts/MarkdownPostLayout.astro
title: 'WSL2 代理配置：LAN 模式下让 WSL 永久走 Clash'
pubDate: 2025-12-20
lastUpdateDate: 2025-12-20
tags: [WSL2, Ubuntu, Windows, Proxy, Clash, LAN]
---

## 简易教程
1. 让 Clash 能被 WSL 连到

    在 Clash 里开启：
    
    - Allow LAN（允许局域网连接）
        ![image.png](/src/assets/images/blog-00001.md/允许局域网连接.png)
    - 记下端口
        ![image.png](/src/assets/images/blog-00001.md/记下端口.png)
    
2. 写入配置文件

    在 WSL 中执行：

    ```bash
    sudo tee /etc/profile.d/proxy.sh >/dev/null <<EOF
    WIN_HOST=\$(ip route show | awk '/default/ {print \$3}')
    export http_proxy="http://\$WIN_HOST:<Clash 端口>"
    export https_proxy="http://\$WIN_HOST:<Clash 端口>"
    export all_proxy="socks5://\$WIN_HOST:<Clash 端口>"
    export no_proxy="localhost,127.0.0.1,::1,*.local"
    EOF
    ```
3. 测试是否联通

    在 WSL 中执行：

    ```bash
    curl -I https://google.com
    ```

## 原理

### 1. LAN 是什么？

LAN = Local Area Network（局域网）。

就是你家里/公司里那一小片网络：同一个路由器（或交换机）下面的设备互相连在一起。

- 典型设备：你的电脑、手机、NAS、打印机、电视盒子
- 典型 IP：`192.168.x.x`、`10.x.x.x`、`172.16~31.x.x`（这些叫“私有地址”）
- 直观理解：同一个 Wi-Fi / 同一根网线后面的“内部网络”

在 LAN 里，设备之间通常可以直接互相访问（前提是防火墙/权限允许），比如手机访问 NAS：`http://192.168.1.50:5000`。

### 2. 创建（或覆盖）一个文件

```bash
sudo tee /etc/profile.d/proxy.sh >/dev/null <<EOF
...
EOF
```

- `sudo`：用管理员权限执行。
- `tee /etc/profile.d/proxy.sh`：`tee` 会把“输入的文本”写入到这个文件里。
    
    默认 `tee` 也会把内容同时打印到屏幕上。
    
- `>/dev/null`：把 `tee` 本来会打印到屏幕的内容丢掉（不让它刷屏）。
    - `>` 叫重定向（redirect）
        
        在 Linux 里，每个程序通常有：
        
        - 标准输出（stdout，编号 1）：程序正常打印的内容
        - 标准错误（stderr，编号 2）：报错信息
        
        `>`  默认是把标准输出（stdout） 送到别的地方，而不是显示在屏幕上。
        
    - `/dev/null` 是一个特殊文件，俗称黑洞：
        - 你往里面写任何东西，都会“消失”
        - 读它也读不到有用内容
- `<<EOF`：这是 *Here document*（多行输入）。
    
    意思是：“接下来直到出现单独一行 `EOF` 之前的所有内容，都当作输入喂给 `tee`”。
    

### 3. 在 WSL 里查 Windows 主机

```bash
IPWIN_HOST=\$(ip route show | grep -i default | awk '{ print $3}')
```

1. `ip route show` 是什么
    - `ip`：Linux 的网络管理工具
    - `route`：看路由表
    - `show`：把路由表显示出来
2. `|` 管道符是什么意思？
    
    `|` 的意思是：把左边命令的输出，当作右边命令的输入。
    
3. `grep -i default` 在做什么？
    - `grep`：按关键词过滤行
    - `i`：忽略大小写（default / Default 都算）
    - 让 `grep` 去输入文本里找包含 default 这几个字母的行。
4. `awk '{ print $3 }'` 在做什么？
    
    `awk` 是按“列”处理文本的工具，默认用空格分列。`print $3` 就是“只打印第 3 列”。
    

### 4. 设置环境变量

```bash
export http_proxy="http://\$WIN_HOST:<Clash 端口>"
```

设置环境变量 `http_proxy`，告诉命令行程序：访问 HTTP 网站时走这个代理。

其余环境变量同理。

### 5. 设置“不走代理”的地址列表

```bash
export no_proxy="localhost,127.0.0.1,::1,*.local"
```

- `localhost` / `127.0.0.1`：本机回环
- `::1`：IPv6 的本机回环
- `.local`：局域网常见的本地域名（mDNS/局域网服务）

访问这些地址时直连，别绕代理（否则经常会慢、或本地服务访问失败）。

### 6. 验证是否成功

```bash
curl -I https://google.com
```

- `curl` 是一个命令行工具，用来发起网络请求（HTTP/HTTPS 最常见），把服务器响应拿回来给你看。
- `-I` 是 `--head` 的缩写：
    
    意思是只请求 HTTP 的响应头（Headers），不下载网页正文（HTML 内容）。

## 参考

1. [Accessing network applications with WSL](https://learn.microsoft.com/en-us/windows/wsl/networking)